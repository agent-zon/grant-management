# Development Workflow Rules

**Version:** 2.0  
**Created:** 2025-10-09  
**Last Updated:** 2026-01-28  
**Owner:** Development Team  

## 1) Purpose

This rule defines the mandatory development workflow to ensure code quality, prevent production issues, and maintain a reliable deployment process.

## 2) Core Principle

**NEVER commit or deploy code without local testing first.**

## 3) Mandatory Workflow

### 3.1 Local Testing Requirements

**BEFORE any commit or deployment, you MUST:**

1. **Test locally** using `npm run dev`
2. **Verify the application starts** without errors
3. **Test the specific functionality** you modified
4. **Check server logs** for any errors or warnings
5. **Validate the full user flow** works end-to-end

### 3.2 Local Testing Commands

```bash
# Start development server
npm run dev

# Test specific endpoints (example)
curl -H "Accept: text/html" http://localhost:4004/demo/index
curl -H "Accept: text/html" http://localhost:4004/demo/request

# Check for linting errors
npm run lint

# Run any available tests
npm test
```

### 3.3 MCP Testing Requirements

**For ALL MCP-related work, you MUST test using the MCP Inspector CLI script:**

**Quick Test Commands (Recommended):**

```bash
# Test against LOCAL server (localhost:4004) - Use during development
npm run test:mcp:list-tools:local

# Test against PRODUCTION/STAGING server - Use for integration testing
npm run test:mcp:list-tools

# Full MCP Inspector test with password grant (uses TEST_USER/TEST_PASSWORD from .env)
npm run test:mcp

# Or manually with cds bind for hybrid mode
npx cds bind --profile hybrid --exec -- node scripts/test-mcp-inspector.js

# With manually provided token
MCP_TOKEN="your-token" node scripts/test-mcp-inspector.js

# With custom URL and method
MCP_URL="https://your-server.com/mcp/streaming" MCP_METHOD="tools/call" npm run test:mcp
```

**MCP Test Scripts Explained:**

- **`test:mcp:list-tools:local`** - Tests against local server (`http://localhost:4004/mcp/streaming`)
  - Uses `mcps.local.json` configuration
  - Requires local server running (`npm run dev`)
  - Automatically fetches token via `token:user` script
  - Best for: Local development and testing

- **`test:mcp:list-tools`** - Tests against production/staging server
  - Uses `mcps.json` configuration  
  - Connects to `https://agents-srv-grants.c-127c9ef.stage.kyma.ondemand.com/mcp/streaming`
  - Automatically fetches token via `token:user` script
  - Best for: Integration testing against deployed server

- **`test:mcp`** - Full MCP Inspector test script
  - Uses `scripts/test-mcp-inspector.js`
  - Supports custom URLs, methods, and tokens via environment variables
  - More flexible but requires manual configuration

**Alternative: Direct MCP Inspector CLI (for manual testing):**

```bash
# Start the CDS server first (in one terminal)
npm run dev

# In another terminal, run MCP Inspector interactively
npm run inspector:mcp

# Or directly:
npx @modelcontextprotocol/inspector --config ./mcps.json --server grant-management

# With CLI mode and specific method (production):
npx @modelcontextprotocol/inspector --cli --config ./mcps.json --server grant-management --method tools/list --header "Authorization: Bearer $(npm run token:user --silent)"

# With CLI mode and specific method (local):
npx @modelcontextprotocol/inspector --cli --config ./mcps.local.json --server grant-management --method tools/list --header "Authorization: Bearer $(npm run token:user --silent)"
```

**MCP Testing Checklist:**
- [ ] MCP server starts without errors
- [ ] Inspector connects successfully
- [ ] Authorization configured (if required)
- [ ] Token acquired successfully (password grant or client credentials)
- [ ] Token has `sid` or `jti` claim for grant lookup
- [ ] All MCP tools are discoverable (`tools/list` works)
  - [ ] Tested locally: `npm run test:mcp:list-tools:local`
  - [ ] Tested against staging: `npm run test:mcp:list-tools`
- [ ] Tool execution works end-to-end (`tools/call` works)
- [ ] Streaming responses function correctly (if applicable)
- [ ] Error handling works as expected

**MCP Test Script Usage:**

The `scripts/test-mcp-inspector.js` script provides automated testing with:
- Automatic token acquisition (password grant or client credentials)
- Token claim validation (checks for `sid`/`jti`)
- Direct MCP Inspector CLI execution with proper headers
- Support for custom URLs, methods, and tokens

**Environment Variables for MCP Testing:**
- `TEST_USER` - Test user email/username (for password grant)
- `TEST_PASSWORD` - Test user password (for password grant)
- `MCP_TOKEN` - Manually provided token (skips token fetch if set)
- `MCP_URL` - MCP server URL (defaults to production server)
- `MCP_TRANSPORT` - Transport type: "http" or "sse" (defaults to "http")
- `MCP_METHOD` - MCP method to call (defaults to "tools/list")
- `MCP_RESOURCE` - Resource for token request (e.g., "grant-mcp")

**Mock Tokens for MCP Testing (TBD):**

Mock token support for MCP testing is planned but not yet implemented. When available, it will allow testing MCP functionality without requiring real authentication credentials.

**Current Status:** Mock tokens are not supported for MCP testing. Use password grant with `TEST_USER`/`TEST_PASSWORD` or provide a valid token via `MCP_TOKEN`.

**Future Implementation:** Mock token generation and validation for MCP endpoints will be documented here once implemented.

**Reference:** See `scripts/test-mcp-inspector.js` for complete implementation.

**MCP Test Scripts Available:**

The following test scripts are available for MCP testing:

- **`test:mcp`** - Full MCP Inspector test with custom configuration
- **`test:mcp:list-tools`** - Quick test: List tools from production/staging server
- **`test:mcp:list-tools:local`** - Quick test: List tools from local server

**Token Script:**

- **`token:user`** - Fetches access token for MCP authentication
  - Outputs only the token to stdout (suitable for command substitution)
  - Usage: `TOKEN=$(npm run token:user --silent)`
  - Used internally by `test:mcp:list-tools` scripts via `$(npm run token:user --silent)`

**Future MCP Test Scripts (to be created):**

Following the pattern of `test:oauth:basic` and `test:oauth:stepup`, create additional test scripts for different MCP scenarios:

```json
{
  "test:mcp:call": "npx -y @modelcontextprotocol/inspector@latest --cli --config mcps.json --server grant-management --method tools/call --name <tool-name> --arguments '{}' --header \"Authorization: Bearer $(npm run token:user --silent)\"",
  "test:mcp:resources": "npx -y @modelcontextprotocol/inspector@latest --cli --config mcps.json --server grant-management --method resources/list --header \"Authorization: Bearer $(npm run token:user --silent)\"",
  "test:mcp:prompts": "npx -y @modelcontextprotocol/inspector@latest --cli --config mcps.json --server grant-management --method prompts/list --header \"Authorization: Bearer $(npm run token:user --silent)\""
}
```

Each script uses the MCP Inspector CLI with token from `token:user` script. Infrastructure for these will be set up later.

**MCP Inspector Authorization:**

The `test-mcp-inspector.js` script automatically handles authorization by:
1. Acquiring a token (password grant or client credentials)
2. Passing it via `--header "Authorization: Bearer <token>"` to MCP Inspector CLI

**Direct MCP Inspector CLI Usage (Manual Testing):**

For manual testing with MCP Inspector CLI, use the `--header` flag with token from `token:user`:

```bash
# Test with Bearer token header (production/staging)
npx -y @modelcontextprotocol/inspector@latest \
  --cli \
  --config mcps.json \
  --server grant-management \
  --method tools/list \
  --header "Authorization: Bearer $(npm run token:user --silent)"

# Test with Bearer token header (local)
npx -y @modelcontextprotocol/inspector@latest \
  --cli \
  --config mcps.local.json \
  --server grant-management \
  --method tools/list \
  --header "Authorization: Bearer $(npm run token:user --silent)"

# Test specific tool execution
npx -y @modelcontextprotocol/inspector@latest \
  --cli \
  --config mcps.json \
  --server grant-management \
  --method tools/call \
  --name tool-name \
  --arguments '{"param": "value"}' \
  --header "Authorization: Bearer $(npm run token:user --silent)"
```

**For Local Development (No Auth):**

If testing locally without authentication (mock mode):
```bash
npx -y @modelcontextprotocol/inspector@latest \
  --cli \
  --config mcps.local.json \
  --server grant-management \
  --method tools/list
```

**Reference:** 
- See `mcps.json` for production/staging MCP server configuration
- See `mcps.local.json` for local MCP server configuration
- See `scripts/get-mcp-token.js` for token acquisition script
- See `scripts/mcp-inspector.js` for MCP Inspector wrapper script

### 3.4 Mock Authentication for Tests

**For testing without real authentication services, use mock auth:**

1. **Ensure no auth credentials are configured** - Mock auth is used when `cds.requires.auth.credentials` is undefined
2. **Mock tokens are automatically generated** - The system will create mock tokens with format `mk_${ulid()}`
3. **Test flows work without IAS/XSUAA** - All OAuth flows can be tested in mock mode

**Mock Auth Testing:**
```bash
# Run tests with mock auth (no credentials required)
npm test

# Test specific OAuth flows
npm run test:oauth
npm run test:oauth:basic
npm run test:oauth:stepup
npm run test:grant-mgmt
```

**Reference:** See `test-e2e/auth.spec.js` for authentication testing examples.

### 3.5 Hybrid Mode Password Grant Testing

**For hybrid mode testing with real authentication, use password grant type:**

**Setup:**

1. **Install dotenv** (if not already installed):
   ```bash
   npm install dotenv
   ```

2. **Create/update `.env` file** in project root:
   ```bash
   # Test user credentials for password grant
   TEST_USER=your-test-user@example.com
   TEST_PASSWORD=your-test-password
   ```

3. **Load environment variables** in your test/script:
   ```javascript
   import dotenv from 'dotenv';
   dotenv.config();
   
   const TEST_USER = process.env.TEST_USER;
   const TEST_PASSWORD = process.env.TEST_PASSWORD;
   ```

4. **Use IdentityService.fetchPasswordToken** to get user token:
   ```javascript
   import { IdentityService } from '@sap/xssec';
   import cds from '@sap/cds';
   import dotenv from 'dotenv';
   
   dotenv.config();
   
   const credentials = cds.env.requires.auth.credentials;
   const authService = new IdentityService(credentials);
   
   // Fetch user token using password grant
   const tokenResponse = await authService.fetchPasswordToken(
     process.env.TEST_USER,
     process.env.TEST_PASSWORD,
     {
       grant_type: 'password',
       // Add any additional options as needed
     }
   );
   
   console.log('Access Token:', tokenResponse.access_token);
   console.log('Expires In:', tokenResponse.expires_in);
   ```

**Hybrid Mode Testing Commands:**
```bash
# Run auth tests in hybrid mode
npm run test:auth

# Or manually with cds bind
npx cds bind --profile hybrid --exec -- node ./test-e2e/auth.spec.js
```

**Environment Variables Required:**
- `TEST_USER` - Test user email/username
- `TEST_PASSWORD` - Test user password
- Auth service credentials must be configured in `cds.env.requires.auth.credentials`

**Reference:** See `test-e2e/auth.spec.js` for complete implementation example.

### 3.6 Deployment Commands

**For this project, use:**

```bash
# Deploy to Cloud Foundry
npm run deploy

# Alternative (if npm script not available)
mbt build && cf deploy mta_archives/[latest-mtar-file]
```

## 4) Commit Guidelines

### 4.1 Commit Message Format

```
<type>: <short description>

<detailed description>
- <change 1>
- <change 2>
- <change 3>

✅ Local testing confirmed:
- <test 1 passed>
- <test 2 passed>
- <test 3 passed>
```

### 4.2 Required Testing Evidence

**Every commit MUST include evidence of local testing:**

- ✅ Server starts without errors
- ✅ Modified functionality works
- ✅ No new console errors
- ✅ User flow complete
- ✅ Database operations successful (if applicable)
- ✅ MCP tools tested with `npm run test:mcp:list-tools:local` (if MCP-related changes)
  - ✅ Local testing: `npm run test:mcp:list-tools:local`
  - ✅ Staging testing: `npm run test:mcp:list-tools` (if applicable)
- ✅ Authentication flows tested (mock or hybrid mode as appropriate)

## 5) Error Prevention

### 5.1 Common Issues to Check

- **Database schema mismatches** - verify entity relationships
- **Missing dependencies** - check package.json
- **TypeScript/linting errors** - run linters
- **API endpoint errors** - test with curl/browser
- **Authentication issues** - verify auth flows
- **MCP server connection issues** - test with Inspector CLI
- **MCP authorization failures** - verify Bearer token is passed correctly via --header flag
- **Missing environment variables** - check `.env` file for TEST_USER/TEST_PASSWORD
- **IdentityService errors** - verify credentials configuration

### 5.2 Red Flags (Stop and Fix)

- ❌ Server won't start
- ❌ 500 errors in logs
- ❌ TypeScript compilation errors
- ❌ Database constraint violations
- ❌ Missing environment variables
- ❌ MCP Inspector cannot connect to server
- ❌ MCP authorization fails (check Bearer token passed via --header flag)
- ❌ Password grant token fetch fails (check TEST_USER/TEST_PASSWORD)
- ❌ IdentityService throws errors (verify credentials configuration)

## 6) Deployment Checklist

**Before running `npm run deploy`:**

- [ ] Code committed to git
- [ ] Local testing completed successfully
- [ ] No linting errors
- [ ] Server logs clean
- [ ] All modified endpoints tested
- [ ] Database operations verified
- [ ] User flows validated
- [ ] MCP tools tested with `npm run test:mcp:list-tools:local` (if MCP-related)
  - [ ] Local server test: `npm run test:mcp:list-tools:local`
  - [ ] Staging server test: `npm run test:mcp:list-tools` (if applicable)
- [ ] Authentication tested (mock or hybrid mode)
- [ ] Environment variables configured (if using hybrid mode)

## 7) Post-Deployment Verification

**After deployment:**

1. **Check application status**: Verify apps are running
2. **Test live endpoints**: Confirm functionality works in production
3. **Monitor logs**: `cf logs [app-name]` for any issues
4. **Validate user flows**: Test critical paths

## 8) Rollback Procedure

**If deployment fails or causes issues:**

```bash
# Check deployment logs
cf logs [app-name] --recent

# Rollback if needed (revert commit and redeploy)
git revert [commit-hash]
npm run deploy
```

## 9) Development Environment Setup

### 9.1 Required Tools

- Node.js (version specified in package.json)
- npm or yarn
- Cloud Foundry CLI (`cf`)
- MTA Build Tool (`mbt`)

### 9.2 Environment Variables

Ensure all required environment variables are set for local development.

**Required for Hybrid Mode Testing:**
- `TEST_USER` - Test user email/username for password grant
- `TEST_PASSWORD` - Test user password for password grant

**Optional for MCP Testing:**
- `MCP_TOKEN` - Bearer token for MCP server authorization (if manually provided)

**Setup `.env` file:**
```bash
# Copy example if available, or create new
cp .env.example .env

# Add test credentials
echo "TEST_USER=your-test-user@example.com" >> .env
echo "TEST_PASSWORD=your-test-password" >> .env
```

**Important:** Never commit `.env` files to git. They are already in `.gitignore`.

## 10) Enforcement

**This workflow is MANDATORY for all developers.**

- **Violations**: Committing untested code or deploying broken functionality
- **Consequences**: Code review rejection, deployment rollback, additional testing requirements

## 11) Examples

### 11.1 Good Commit Example

```
Fix database schema mismatch in authorization handlers

- Fixed PAR handler to use correct grant_id foreign key field
- Updated authorize and token handlers to use request.grant_id consistently  
- Resolved 500 error in /demo/request endpoint

✅ Local testing confirmed: 
- Server starts without errors
- Grant creation successful
- Authorization flow complete
- Token exchange working
- State machine progression functional
- MCP Inspector tested with `npm run test:mcp:list-tools:local` (if MCP changes)
  - Local test: `npm run test:mcp:list-tools:local`
  - Staging test: `npm run test:mcp:list-tools` (if applicable)
- Password grant tested with TEST_USER (if hybrid mode)
```

### 11.2 Bad Commit Example (DON'T DO THIS)

```
Fix authorization issue

- Changed some fields
- Should work now
```

**Problems:**
- No specific description
- No testing evidence
- Vague changes
- No verification

## 12) Tools Integration

### 12.1 IDE Setup

Configure your IDE to:
- Run linters on save
- Show TypeScript errors
- Auto-format code
- Highlight syntax errors

### 12.2 Git Hooks (Recommended)

Set up pre-commit hooks to:
- Run linters
- Check TypeScript compilation
- Prevent commits with console.log statements
- Validate commit message format

---

**Remember: A few minutes of local testing saves hours of debugging production issues!**